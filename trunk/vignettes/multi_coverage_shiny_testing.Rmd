---
title: "Multiple Chip-Seq Heatmap Example"
author: "Alicia Schep"
date: "7/8/2016"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Reading in the Data

Example of reading in data

```{r inputs}
library(gChipseq)
library(TxDb.Mmusculus.BioMart.igis)

file.sample <- "~/workspace/BAP1_Data/BAP1_june_2016_samples.txt"
file.pair <- "~/workspace/BAP1_Data/BAP1_june_2016_pairs.txt"

samples <- read.table(file.sample,as.is=TRUE,header=TRUE)
samples <- expandSampleTable(samples)

pairs <- read.table(file.pair,as.is=TRUE,header=TRUE)
pairs <- expandPairedTable(pairs)

tss <- tssFromTxdb(txdb = TxDb.Mmusculus.BioMart.igis)
unique_tss <- unique(tss) #Remove same positions

peaks <- lapply( pairs$File.macs, readMacsPeaks, fc=5, minTags=10, fdr=0.1)
peaks <- peaks[!sapply(peaks, is.null)]

merged_peaks <- reduce(do.call(c, peaks))

tss_in_peaks <- subsetByOverlaps(unique_tss, merged_peaks, maxgap = 2500)

```

## Prepping Data
```{r bams}
source('/gnet/is7/workspace/schepa/chipVis/R/coverage_matrix.R')
BiocParallel::register(BiocParallel::MulticoreParam(4, progressbar = TRUE))

bam_files <- samples$File.bam
names(bam_files) <- samples$Sample.Name

# cvg_mats <- make_coverage_matrix(inputs = bam_files,
#                                  ranges = tss_in_peaks,
#                                  binsize = 50,
#                                  up = 2500,
#                                  down = 2500)

```


## Embedded Application


```{r shiny, echo=FALSE}
source('/gnet/is7/workspace/schepa/chipVis/R/multi_coverage_shiny.R')

multi_coverage_plot(inputs = cvg_mats,#bam_files, 
                    regions = tss_in_peaks, 
                    region_names = tss_in_peaks$names, 
                    up = 2500, 
                    down = 2500)

```




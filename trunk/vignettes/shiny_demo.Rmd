---
title: "inteRomics Shiny Demo"
author: "Alicia Schep and Justin Finkle"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
runtime: shiny
---

<style type="text/css">

body, td {
   font-size: 14px;
}
code.r{
  font-size: 20px;
}
pre {
  font-size: 20px
}
</style>

```{r setup, include=FALSE, echo=TRUE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE, autodep=TRUE, warning = FALSE, message = FALSE)
#library(gChipseq)
library(chipVis)
library(TxDb.Hsapiens.BioMart.igis3.0)
library(org.Hs.eg.db)
library(plotly)
library(dplyr)
library(iHeatmapR)
BiocParallel::register(BiocParallel::MulticoreParam(4, progressbar = FALSE))
```


``` {r Load Data, echo = FALSE}

fi <- readRDS("/gne/research/workspace/schepa/Carroll_Data/chip_file_info.Rds")

org <- "human"
genome <- "GRCh38"

# Get scaling factors based on library size
sf <- get_scaling_factor(fi)[2,]/1000000

rpkmEset <- readRDS("/gne/research/workspace/schepa/Carroll_Data/GSE68358.rpkmEset.with_fdata.Rds")

tss_ranges <- with(fData(rpkmEset), GenomicRanges::GRanges(chr,
                                               IRanges::IRanges(start = ifelse(strand == "-",
                                                                               end,
                                                                               start),
                                                                width = 1),
                                               strand = strand,
                                               symbol = symbol,
                                               entrez = entrez))

```
  

```{r, echo = FALSE}
T47D_eset <- rpkmEset[,grep("T47D",pData(rpkmEset)$celltype)]
treat_groups = stringr::str_trim(sapply(stringr::str_split(pData(T47D_eset)$treatment,":"), 
                      function(x) x[[2]])) %>% gsub("+","_",., fixed= TRUE) %>% 
  gsub("_3hr","",.)

library(limma)
library(edgeR)

dge <- DGEList(counts = exprs(T47D_eset)) %>% calcNormFactors()
design <- model.matrix(~ 0 +treat_groups)
colnames(design) = gsub("treat_groups", "", colnames(design))
v <- voom(dge, design=design)
fit <- lmFit(v, design)
contrasts <- makeContrasts(E2_Progesterone-E2, 
                           E2_R5020-E2, 
                           E2_R5020-E2_Progesterone, levels = design)
fit2 <- contrasts.fit(fit, contrasts) %>% eBayes()
results_Progesterone <- topTable(fit2, coef = 1, adjust = "BH")
results_R5020 <- topTable(fit2, coef = 2, adjust = "BH")


results <- decideTests(fit2, p.value = 0.01, lfc = 1)
sig <- which(apply(results,1, function(x) sum(x!=0) > 0))

T47D = list(
  ER_ab = which(fi$source_name == "T47D_ER_Full_Media_3hr"),
  ER_ab_Pr_treat = which(fi$source_name == "T47D_ER_Progesterone_3hr"),
  ER_ab_R5020_treat = which(fi$source_name == "T47D_ER_R5020_3hr"),
  
  PR_ab  = which(fi$source_name == "T47D_PR_Full_Media_3hr"),
  PR_ab_Pr_treat = which(fi$source_name == "T47D_PR_Progesterone_3hr"),
  PR_ab_R5020_treat = which(fi$source_name == "T47D_PR_R5020_3hr"),
  
  p300_ab  = which(fi$source_name == "T47D_p300_Full_Media_3hr"),
  p300_ab_Pr_treat  = which(fi$source_name == "T47D_p300_Progesterone_3hr"),
  p300_ab_R5020_treat = which(fi$source_name == "T47D_p300_R5020_3hr")
  
)
col_group_names <- gsub(pattern = "Progesterone", replacement = "P4", treat_groups)

```


```{r, echo = FALSE}
rna_hm <- genomics_heatmap(v$E[sig,], 
                           col_groups = col_group_names, 
                           row_groups_palette = c("#d6696a","#69a0d6"),
                           row_groups_name = "Gene<br>Clusters",
                           row_k = 2,
                           x = pData(T47D_eset)$title, 
                           y = fData(T47D_eset)$symbol[sig],
                           name = "RNA-seq", 
                           colorbar_grid = setup_colorbar_grid(x_spacing = 0.2, 
                                                               nrow = 3),
                           colorscale = diverging_colorscale(c(scales::muted("blue"),
                                                               "white", scales::muted("red")))) 

#rna_hm
```


  

```{r T47D_tss_cvg, echo = FALSE}

promoter_ranges = GenomicRanges::promoters(tss_ranges,
                                                 up = 5000,
                                                 down = 5000)

er_promoter_counts <- simplify2array(
  BiocParallel::bplapply(fi$File.bam[unlist(T47D[1:3])],
                         bamsignals::bamCount,
                         promoter_ranges[sig])) %>% 
  scale(center = FALSE, scale = sf[unlist(T47D[1:3])])

pr_promoter_counts <- simplify2array(
  BiocParallel::bplapply(fi$File.bam[unlist(T47D[4:6])],
                         bamsignals::bamCount,
                         promoter_ranges[sig])) %>% 
  scale(center = FALSE, scale = sf[unlist(T47D[4:6])])

p300_promoter_counts <- simplify2array(
  BiocParallel::bplapply(fi$File.bam[unlist(T47D[7:9])],
                         bamsignals::bamCount,
                         promoter_ranges[sig])) %>% 
  scale(center = FALSE, scale = sf[unlist(T47D[7:9])])


colnames(er_promoter_counts) <- unlist(fi$source_name[unlist(T47D[1:3])], use.names= FALSE)
er_chip_condition <- unlist(fi$condition[unlist(T47D[1:3])], use.names= FALSE)


colnames(pr_promoter_counts) <- unlist(fi$source_name[unlist(T47D[4:6])], use.names= FALSE)
pr_chip_condition <- unlist(fi$condition[unlist(T47D[4:6])], use.names= FALSE)

colnames(p300_promoter_counts) <- unlist(fi$source_name[unlist(T47D[7:9])], use.names= FALSE)
p300_chip_condition <- unlist(fi$condition[unlist(T47D[7:9])], use.names= FALSE)

#COLLAPSE CHIP

er_promoter_counts_collapsed <- sapply(unique(er_chip_condition),
                                      function(x){
                                        tmp <- which(er_chip_condition == x)
                                        apply(er_promoter_counts[,tmp], 1, sum, na.rm = TRUE)
                                      })

pr_promoter_counts_collapsed <- sapply(unique(pr_chip_condition),
                                      function(x){
                                        tmp <- which(pr_chip_condition == x)
                                        apply(pr_promoter_counts[,tmp], 1, sum, na.rm = TRUE)
                                      })

p300_promoter_counts_collapsed <- sapply(unique(p300_chip_condition),
                                      function(x){
                                        tmp <- which(p300_chip_condition == x)
                                        apply(p300_promoter_counts[,tmp], 1, sum, na.rm = TRUE)
                                      })

er_promoter_counts_diff <- log2(er_promoter_counts_collapsed[,2:3] / er_promoter_counts_collapsed[,1])
pr_promoter_counts_diff <- log2(pr_promoter_counts_collapsed[,2:3] / pr_promoter_counts_collapsed[,1])
p300_promoter_counts_diff <- log2(p300_promoter_counts_collapsed[,2:3] / p300_promoter_counts_collapsed[,1])
er_untreated <- er_promoter_counts_collapsed[,1]
pr_untreated <- pr_promoter_counts_collapsed[,1]
p300_untreated <- p300_promoter_counts_collapsed[,1]
untreated_range <- range(c(er_untreated, pr_untreated, p300_untreated))
diff_range <- range(c(er_promoter_counts_diff, pr_promoter_counts_diff, p300_promoter_counts_diff))


rna_chip_collapsed_hm <- rna_hm %>% 
  add_genomics_heatmap(er_promoter_counts_diff,
                       col_groups = c("P4","R5020"),
                       col_groups_name = "Treatment",
                       col_groups_palette = "Paired",
                       colorscale = diverging_colorscale("PiYG"),
                       scale = "none",
                       name = "Avg ChIP<br> treated vs untreated",
                       size = 0.2, buffer = 0.1,
                       x_title = "ER",
                       zmin = diff_range[1],
                       zmax = diff_range[2]) %>%
  add_row_signal(er_untreated, 
                 name = "Untreated", 
                 x_title= 'ER<br> Untreated', 
                 colorscale = continuous_colorscale("Greys"),
                 zmin = untreated_range[1], 
                 zmax = untreated_range[2]) %>% 
  add_genomics_heatmap(pr_promoter_counts_diff,
                       col_groups = c("Progesterone","R5020"),
                       col_groups_palette = "Paired",
                       colorscale = diverging_colorscale("PiYG"),
                       scale = "none",
                       show_col_groups_colorbar = FALSE,
                       show_color = FALSE,
                       name = "PR ChIP<br>vs untreated",
                       size = 0.2, 
                       buffer = 0.1,
                       x_title = "PR",
                       zmin = diff_range[1],
                       zmax = diff_range[2]) %>%
  add_row_signal(pr_untreated, 
                 name = "PR ChIP <br> Untreated", 
                 x_title = 'PR<br> Untreated', 
                 colorscale = continuous_colorscale("Greys"), 
                 show_colorbar = FALSE,
                 zmin = untreated_range[1], 
                 zmax = untreated_range[2]) %>%
  add_genomics_heatmap(p300_promoter_counts_diff,
                       col_groups = c("Progesterone","R5020"),
                       col_groups_palette = "Paired",
                       show_col_groups_colorbar = FALSE,
                       show_color = FALSE,
                       colorscale = diverging_colorscale("PiYG"),
                       scale = "none",
                       name = "p300 ChIP<br>vs untreated",
                       size = 0.2, 
                       buffer = 0.1,
                       x_title = "p300",
                       zmin = diff_range[1],
                       zmax = diff_range[2]) %>%
  add_row_signal(p300_untreated, 
                 name="p300 ChIP <br> Untreated", 
                 x_title = 'p300<br> Untreated',
                 colorscale = continuous_colorscale("Greys"), 
                 show_colorbar = FALSE,
                 zmin = untreated_range[1], 
                 zmax = untreated_range[2]) #%>%
  #plot_iHeatmap() %>% layout(margin = list(l=0, t=0))

```


```{r Match transcripts with symbol, echo = FALSE}
tr <- transcriptsBy(TxDb.Hsapiens.BioMart.igis, by = "gene") %>% unlist()
tr$entrez <- stringr::str_extract(names(tr),"(?<=:)(.*)")
tr$symbol <- annotate::getSYMBOL(tr$entrez, data='org.Hs.eg')
names(tr) = NULL
trdf <- as.data.frame(tr)

truniq <- trdf %>% group_by(entrez) %>% summarize(chr = first(seqnames),
                                                  start = min(start),
                                                  end = min(end),
                                                  strand = first(strand),
                                                  symbol = first(symbol))
tx_data <- load_tx_data(TxDb.Hsapiens.BioMart.igis)
```

```{r Gene Loci, echo=FALSE}
symbol <- "ZNF579"
sym_idx <- which(truniq$symbol == symbol)
symbol_range <- get_view_range(chr = truniq$chr[sym_idx], start = truniq$start[sym_idx],
                               end = truniq$end[sym_idx])
symbol_range <- extend_grange(symbol_range, 50000)

sample_names <- sapply(seq_along(T47D), function(i){
   x <- T47D[[i]]
   n <- paste0(rep(names(T47D)[[i]], length(x)), seq_along(x))})
idx <- unlist(T47D, use.names = FALSE)
range_cvg <- make_coverage_tracks(fi$File.bw[idx], 
                                  target_range = symbol_range,
                                  sample_names = sample_names,
                                  scaling_factors = sf[idx],
                                  binsize = 100)

```

```{r, echo = FALSE}
bw_files <- fi$File.bw[unlist(T47D)]
names(bw_files) <- sample_names

link_function <- heatmap_click(rna_chip_collapsed_hm, tss_ranges[sig])

track_function <- make_browserly_function(bw_files, tx_data)

```

### Setting up the heatmap, link function, and track function

```{r, eval = FALSE, echo = TRUE}
rna_chip_heatmap <- genomics_heatmap(expression_matrix, ...) %>%
    add_genomics_heatmap(er_chip_diff, ...) %>%
    add_row_signal(er_chip_untreated, ...) %>% 
    add_genomics_heatmap(pr_chip_diff, ...) %>%
    add_row_signal(pr_chip_untreated, ...) %>%
    add_genomics_heatmap(p300_chip_diff, ...) %>%
    add_row_signal(p300_chip_untreated, ...) 

link_function <- heatmap_click(rna_chip_heatmap, tss_ranges)

track_function <- make_browserly_function(bigwig_files, transcript_data)
```

### Calling function to make shiny app
```{r, eval = FALSE, echo = TRUE}
heatmap_to_browserly_shiny(rna_chip_heatmap,
                           track_function,
                           link_function)

```

```{r, cache = FALSE, echo = FALSE}
heatmap_to_browserly_shiny(rna_chip_collapsed_hm,
                           track_function,
                           link_function)

```


All data for this demo are from: Mohammed, H. *et al.* Progesterone receptor modulates ERα action in breast cancer. *Nature*. **523**, 313-317 (2015)
